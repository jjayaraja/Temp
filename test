$library = "Documents"
$groupRead = "A-Z Viewers"
$groupContribute = "Subfolder Contributors"

# Get all folders in the library
$folders = Get-PnPListItem -List $library -PageSize 1000 | Where-Object { $_.FileSystemObjectType -eq "Folder" }

foreach ($folder in $folders) {
    $name = $folder.FieldValues["FileLeafRef"]
    if ($name -match '^[A-Z]$') {
        Write-Host "`nProcessing top-level folder '$name'..."

        # Break inheritance and assign Read to A-Z Viewers
        Set-PnPListItemPermission -List $library -Identity $folder.Id -InheritPermissions:$false
        Set-PnPListItemPermission -List $library -Identity $folder.Id -Group $groupRead -AddRole "Read"

        # Get site-relative URL of this folder
        $folderItem = Get-PnPFolder -Url $folder["FileRef"]
        $folderUrl = $folderItem.ServerRelativeUrl.Substring($folderItem.ServerRelativeUrl.IndexOf("/",1))  # Normalize

        # Get subfolders inside the A-Z folder
        $subs = Get-PnPFolderItem -FolderSiteRelativeUrl $folderUrl -ItemType Folder -Recursive

        if ($subs) {
            foreach ($sub in $subs) {
                if ($sub.Name -ne $name) {
                    Write-Host " > Setting permissions on subfolder '$($sub.Name)'..."

                    # Break inheritance and assign Contribute
                    Set-PnPFolderPermission -Folder $sub.ServerRelativeUrl -InheritPermissions:$false
                    Set-PnPFolderPermission -Folder $sub.ServerRelativeUrl -Group $groupContribute -AddRole "Contribute"
                }
            }
        } else {
            Write-Warning "No subfolders found under '$name'"
        }
    }
}
