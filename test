$library = "AE"
$groupRead = "A-Z Viewers"                   # Group A
$groupContribute = "Subfolder Contributors"  # Group B

# Get all top-level folders in the AE library
$folders = Get-PnPListItem -List $library -PageSize 1000 | Where-Object {
    $_.FileSystemObjectType -eq "Folder" -and $_["FileLeafRef"] -match '^[A-Z]$'
}

foreach ($folder in $folders) {
    $folderName = $folder["FileLeafRef"]
    Write-Host "`nProcessing top-level folder '$folderName'..."

    # 1. Break inheritance on A–Z folder and assign Read to Group A
    Set-PnPListItemPermission -List $library -Identity $folder.Id -InheritPermissions:$false
    Set-PnPListItemPermission -List $library -Identity $folder.Id -Group $groupRead -AddRole "Read"

    # 2. Process immediate children (folders/files) of A–Z (like A1, A2, F1, F2, etc.)
    $folderUrl = $folder["FileRef"] -replace "^/sites/[^/]+/", ""
    $children = Get-PnPFolderItem -FolderSiteRelativeUrl $folderUrl

    foreach ($child in $children) {
        Write-Host "  Processing '$($child.Name)' [$($child.ItemType)]"

        try {
            $childFolder = Get-PnPFolder -Url $child.ServerRelativeUrl -Includes ListItemAllFields
            $childId = $childFolder.ListItemAllFields.Id

            if ($childId) {
                # Break inheritance and assign Contribute to Group B
                Set-PnPListItemPermission -List $library -Identity $childId -InheritPermissions:$false
                Set-PnPListItemPermission -List $library -Identity $childId -Group $groupContribute -AddRole "Contribute"
            }

            # 3. Reset permissions on all descendants inside this folder
            if ($child.ItemType -eq "Folder") {
                $childUrl = $child.ServerRelativeUrl.TrimStart('/')
                $descendants = Get-PnPFolderItem -FolderSiteRelativeUrl $childUrl -Recursive

                foreach ($desc in $descendants) {
                    try {
                        $descFolder = Get-PnPFolder -Url $desc.ServerRelativeUrl -Includes ListItemAllFields
                        $descId = $descFolder.ListItemAllFields.Id

                        if ($descId) {
                            Write-Host "    Resetting inheritance for: $($desc.ServerRelativeUrl)"
                            Set-PnPListItemPermission -List $library -Identity $descId -InheritPermissions:$true
                        }
                    } catch {
                        Write-Warning "    Could not reset inheritance on $($desc.ServerRelativeUrl): $_"
                    }
                }
            }

        } catch {
            Write-Warning "  Failed to process '$($child.Name)': $_"
        }
    }
}
