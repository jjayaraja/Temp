# Connect to SharePoint
Connect-PnPOnline -Url "https://tenant.sharepoint.com/sites/yoursite" -Interactive

# Config
$library = "lib"
$groupRead = "groupA"
$groupContribute = "groupA"

# Get all root folders (A-Z)
$rootFolders = Get-PnPListItem -List $library -PageSize 1000 | Where-Object {
    $_.FieldValues.FileSystemObjectType -eq "Folder" -and
    $_.FieldValues.FileLeafRef -match '^[A-Z]$'
}

foreach ($folder in $rootFolders) {
    # Break inheritance on root folder
    Set-PnPListItemPermissionInheritance -List $library -Identity $folder.Id -BreakInheritance -ClearSubscopes

    # Apply "Root Move Only" to groupRead
    Set-PnPListItemPermission -List $library -Identity $folder.Id -Group $groupRead -AddRole "Root Move Only"

    # Get children (folders/files inside root)
    $children = Get-PnPListItem -List $library -PageSize 500 -FolderServerRelativeUrl $folder.FieldValues["FileRef"]

    foreach ($child in $children) {
        # Break inheritance on sub-items
        Set-PnPListItemPermissionInheritance -List $library -Identity $child.Id -BreakInheritance -ClearSubscopes

        # Grant Contribute to groupContribute
        Set-PnPListItemPermission -List $library -Identity $child.Id -Group $groupContribute -AddRole "Contribute"
    }
}

Write-Host "âœ… Permission configuration completed."
