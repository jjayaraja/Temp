function Add-PageSection {
    param(
        [string]$PageName,
        [int]$Retries = 5,
        [int]$Delay = 5
    )
    
    $attempt = 0
    while ($attempt -lt $Retries) {
        try {
            Write-Host "Attempting to add section ($($attempt+1)/$Retries)..."
            
            # Add section using native PnP cmdlet
            $section = Add-PnPPageSection -Page $PageName `
                -SectionTemplate OneColumn `
                -Order 1 `
                -ErrorAction Stop

            if ($section) {
                Write-Host "Section added successfully" -ForegroundColor Green
                return $true
            }
        }
        catch {
            Write-Warning "Section addition attempt $($attempt+1) failed: $_"
            # Refresh page reference
            $page = Get-PnPPage -Identity $PageName -ErrorAction SilentlyContinue
        }
        
        $attempt++
        Start-Sleep -Seconds $Delay
    }
    
    Write-Warning "Failed to add section after $Retries attempts"
    return $false
}




# Modified page processing block
foreach ($htmlFile in $htmlFiles) {
    try {
        # Page name sanitization (corrected)
        $pageNameBase = [IO.Path]::GetFileNameWithoutExtension($htmlFile.Name)
        $pageName = $pageNameBase `
            -replace '[<>:"/\\|?*]', '' `
            -replace '\s+', ' ' `
            | ForEach-Object { $_.Trim() }
        $pageName = $pageName.Substring(0, [Math]::Min($pageName.Length, 50))

        # Delete existing page
        if (Get-PnPPage -Identity $pageName -ErrorAction SilentlyContinue) {
            Remove-PnPPage -Identity $pageName -Force
            Write-Host "Removed existing page: $pageName" -ForegroundColor Yellow
            Start-Sleep -Seconds 5
        }

        # Create new page
        $page = Add-PnPPage -Name $pageName -Title $pageName -LayoutType Article -ErrorAction Stop
        
        # Add section with retries
        if (-not (Add-PageSection -PageName $pageName)) {
            throw "Failed to add section after multiple attempts"
        }

        # Rest of the code remains the same...
        # [HTML processing and web part addition]
    }
    catch {
        Write-Warning "Error processing $pageName : $_"
    }
}
