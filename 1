# Migration Script with Enhanced Error Handling
$siteUrl = "https://contoso.sharepoint.com/sites/yoursite"
$zipFilePath = "C:\path\to\confluence-export.zip"
$tempFolder = "C:\temp\ConfluenceExport"
$imagesLibrary = "SiteAssets/images"
$stylesLibrary = "SiteAssets/styles"

# Connect to SharePoint
Connect-PnPOnline -Url $siteUrl -Interactive -ErrorAction Stop

# Extract ZIP file
if (-not (Test-Path $tempFolder)) { New-Item -Path $tempFolder -ItemType Directory }
Expand-Archive -Path $zipFilePath -DestinationPath $tempFolder -Force

# Ensure asset libraries exist
try {
    $null = Resolve-PnPFolder -SiteRelativePath $imagesLibrary -ErrorAction Stop
    $null = Resolve-PnPFolder -SiteRelativePath $stylesLibrary -ErrorAction Stop
    Write-Host "Verified asset libraries" -ForegroundColor Cyan
}
catch {
    Write-Warning "Could not create asset libraries: $_"
    exit
}

# Upload assets with validation
function Upload-Assets($folderType) {
    $localFolder = Join-Path $tempFolder $folderType
    $targetLibrary = if ($folderType -eq "images") { $imagesLibrary } else { $stylesLibrary }

    if (Test-Path $localFolder) {
        Get-ChildItem $localFolder -Recurse | ForEach-Object {
            try {
                $targetPath = $_.FullName.Replace($localFolder, $targetLibrary)
                $file = Add-PnPFile -Path $_.FullName -Folder $targetPath -ErrorAction Stop
                Write-Host "Uploaded $($file.Name) to $targetPath" -ForegroundColor DarkCyan
            }
            catch {
                Write-Warning "Failed to upload $($_.Name): $_"
            }
        }
    }
    else {
        Write-Warning "Local $folderType folder not found: $localFolder"
    }
}
# Revised Section Creation Function
function Add-PageSection {
    param(
        [string]$PageName,
        [int]$Retries = 5,
        [int]$Delay = 5
    )
    
    $attempt = 0
    while ($attempt -lt $Retries) {
        try {
            Write-Host "Attempting to add section ($($attempt+1)/$Retries)..."

            # Get fresh page reference
            $page = Get-PnPPage -Identity $PageName -ErrorAction Stop
            
            # First try standard PnP method
            $section = Add-PnPPageSection -Page $PageName -SectionTemplate OneColumn -Order 1 -ErrorAction Stop
            
            # If standard method failed, use alternative approach
            if (-not $section) {
                # Add section using CanvasSectionTemplate
                $newSection = $page.Sections.AddSection([PnP.Core.Model.Pages.CanvasSectionTemplate]::OneColumn)
                $page.Save()
                $page.Publish()
                $section = $newSection
            }
            
            if ($section) {
                Write-Host "Section added successfully" -ForegroundColor Green
                return $true
            }
        }
        catch {
            Write-Warning "Section addition attempt $($attempt+1) failed: $_"
            # Force page reload
            $page = Get-PnPPage -Identity $PageName -ErrorAction SilentlyContinue
        }
        
        $attempt++
        Start-Sleep -Seconds $Delay
    }
    
    Write-Warning "Failed to add section after $Retries attempts"
    return $false
}


Upload-Assets -folderType "images"
Upload-Assets -folderType "styles"

# HTML Processing and Page Creation
$htmlFiles = Get-ChildItem -Path $tempFolder -Filter *.html -Recurse

foreach ($htmlFile in $htmlFiles) {
    $pageName = [IO.Path]::GetFileNameWithoutExtension($htmlFile.Name)
    $htmlContent = Get-Content $htmlFile.FullName -Raw

    # Sanitize page name for SharePoint
    $pageName = $pageName -replace '[<>:"/\\|?*]', '' -replace '\s+', ' '
    $pageName = $pageName.Trim().Substring(0, [Math]::Min($pageName.Length, 50))

    # Update resource paths
    $htmlContent = $htmlContent -replace '(src|href)="(images|styles)/', "$1=""$siteUrl/SiteAssets/$2/"

    try {


    # Modern Document Library Checkout Reset
$files = Get-PnPFile -List $libraryName -Recursive -Includes CheckedOutByUser

$files | Where-Object { $_.CheckedOutByUser } | ForEach-Object {
    Write-Host "Resetting checkout for: $($_.ServerRelativeUrl)"
    $_ | Stop-PnPFileVersion -CheckoutType DiscardCheckout -Force
}


        # Delete existing page if present
        if (Get-PnPPage -Identity $pageName -ErrorAction SilentlyContinue) {
            Remove-PnPPage -Identity $pageName -Force
            Write-Host "Removed existing page, waiting for cleanup..."
            Start-Sleep -Seconds 10  # Increased delay for page deletion
        }

        # Create new page with extended timeout
        $page = Add-PnPPage -Name $pageName -Title $pageName -LayoutType Article -ErrorAction Stop
        
        # Wait for page initialization
        Start-Sleep -Seconds 5
        
        # Verify page creation
        $page = Get-PnPPage -Identity $pageName -ErrorAction Stop
        if (-not $page) {
            throw "Page creation verification failed"
        }

        # Add section using enhanced function
        if (-not (Add-PageSection -PageName $pageName)) {
            throw "Critical failure adding section"
        }

        # Add web part content
        $webPart = Add-PnPPageWebPart -Page $pageName -Component "Text" `
            -Section 1 -Column 1 -WebPartProperties @{ innerHtml = $webPartHtml }
        
        # ... [rest of the code remains the same] ...
    }
    catch {
        Write-Warning "ERROR PROCESSING $pageName : $_"
        continue
    }
}

# Navigation Setup with Validation
try {
    $pages = Get-PnPPage -Folder "SitePages" -ErrorAction Stop | Where-Object { $_.Title }
    if (-not $pages) { throw "No pages found in SitePages library" }

    Write-Host "Building navigation for $($pages.Count) pages..."
    $navigationNodes = $pages | ForEach-Object {
        @{
            Title = $_.Title
            Url   = $_.ServerRelativeUrl
        }
    }

    # Clear existing navigation
    Get-PnPNavigationNode -Location QuickLaunch | Remove-PnPNavigationNode -Force -ErrorAction SilentlyContinue

    # Add new nodes
    $navigationNodes | ForEach-Object {
        Add-PnPNavigationNode -Title $_.Title -Url $_.Url -Location QuickLaunch -ErrorAction Stop
    }
    Write-Host "Navigation updated successfully" -ForegroundColor Green
}
catch {
    Write-Warning "Navigation setup failed: $_"
}

# Cleanup
Remove-Item -Path $tempFolder -Recurse -Force -ErrorAction SilentlyContinue
